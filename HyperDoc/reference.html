<!DOCTYPE html>
<head>
<meta charset='utf-8'>
<title>Nth HyperDoc</title>
<link rel="stylesheet" href="style.css">
<style>
body{padding:0;margin:0;}
nth-area{display:block;width:90vw;height:90vh;margin:auto;}
nth-area > *{display:block;border-radius:0.5ch;padding:0;margin:0;}
nth-header{display:block;margin:auto;min-height:5ch;text-align:center;border-bottom:solid var(--fg) 0.2ch;}
nth-left-margin{grid-area:left;box-shadow:var(--fg) 3ch 0 3ch -2ch;}
nth-right-margin{grid-area:right;box-shadow:var(--fg) -3ch 0 3ch -2ch;}
nth-footer{grid-area:bottom;}
nth-help{position:absolute;display:none;top:10vh;left:3ch;width:calc(100vw - 6ch);height:calc(90vh - 2ch);margin:0;background-color:var(--bg);box-shadow:var(--fg) 0 0 13ch 2ch;z-index:10;}
help-button{display:inline-block;cursor:pointer;width:3ch;border-radius:0.5ch;}
help-button:hover{background-color: var(--dbg);}
close-help{display:inline-block;position:relative;top:1ch;left:1ch;cursor:pointer;padding:0.2ch;border-radius:0.5ch;}
close-help:hover{background-color:var(--dbg);}
nth-editor{display:grid;width:max-content;grid-template-areas: 'handle area' 'options area';position:absolute;font-family:monospace;min-height:1ch;min-width:1ch;padding:1ch;z-index:0;background-color:var(--bg);border-radius:1ch;}
nth-editor[active]{z-index:1;}
nth-editor textarea {display:none;appearance:none;width:0;height:0;resize:none;}
nth-handle{cursor:pointer;width:1ch;height:1ch;border-radius:0.5ch;border:solid var(--fg) 0.2ch;line-height:2ch;text-align:center;grid-area:handle;display:grid;justify-content:flex-start;align-items:center;margin:0.2ch;}
nth-editor[active] nth-handle{border-color:var(--lfg);}
nth-editor[active] nth-options{color:var(--lfg);}
nth-options{display:none;flex-flow:column nowrap;grid-area:options;justify-content:flex-start;transition:all 0.2s;background-color:var(--bg);color:var(--fg);box-shadow:var(--bg) 0 0 1ch;position:relative;top:2ch;left:-0.5ch;}
nth-options *{display:grid;justify-content:center;align-items:center;width:2ch;height:2ch;line-height:2ch;border-radius:0.5ch;text-align:center;cursor:pointer;margin-left:0.2ch;margin-right:0.2ch;}
nth-options *:hover{background-color:var(--dbg);}
nth-editor[active] nth-handle:hover nth-options{display:flex;}
nth-editor:hover nth-options{display:flex}
nth-code{grid-area:area;font-size:calc(var(--scale) * 0.5);user-select:none;max-width:69vw;padding:0.2ch;}
nth-symbol, nth-expression, nth-quote, nth-line{display:inline-block;min-width:1ch;line-height:1lh;min-height:1lh;border: none var(--bg) 0.2ch;border-radius:0.5ch;}
nth-expression{border-radius:0.5ch;height:min-content;width:fit-content;vertical-align:top;}
nth-editor[active] nth-expression[active]{border:solid var(--lfg) 0.2ch;}
nth-expression > * + *{margin-left:1ch;}
nth-expression > br + *, nth-symbol + nth-expression{margin-left:0ch;}
nth-editor[active] nth-symbol[active]{background-color:var(--dbg)}
nth-symbol:empty{min-height:0;vertical-align:bottom;}
</style>
</head>
<body>
<nth-header>The <i>n</i><sup>th</sup> Reference Implementation<br><help-button>?</help-button></nth-header>
<nth-help><close-help>close</close-help></nth-help>
<nth-area>
</nth-area>
</body>
<script>
var area = document.getElementsByTagName('nth-area')[0]
var help = document.getElementsByTagName('nth-help')[0]
var helpbutton = document.getElementsByTagName('help-button')[0]
var closehelp = document.getElementsByTagName('close-help')[0]
helpbutton.addEventListener('click', (e)=>help.style.display = 'block')
closehelp.addEventListener('click', (e)=>help.style.display = 'none')
active = null;
area.onclick = (e)=> 
{
    if (area['clicklock']) {area['clicklock'] = false; return;}
    if (e.target.tagName != 'NTH-AREA') return;
    e.preventDefault()
    var snippet = document.createElement('nth-editor')
    for (var x = 0; x < area.childElementCount; x++)
    area.children[x].removeAttribute('active')
    snippet.setAttribute('active', 'true')
    active = snippet
    snippet.innerHTML = 
    '<textarea cols="0" rows="0" autocapitalize="false" autocomplete="false" autocorrect="false" spellcheck="false"></textarea>\
    <nth-handle>\
    <nth-options><nth-run>&#x23f5;</nth-run><nth-step>&#x21dd;</nth-step><nth-close>&#x2a2f;</nth-close></nth-options>\
    </nth-handle>\
    <nth-code></nth-code>'
    snippet.lastChild['caret'] = null;
    snippet.children[1].children[0].lastChild.onclick = (e) => {area.removeChild(snippet)}
    snippet.style.top = String(e.clientY) + 'px'
    snippet.style.left = String(e.clientX) + 'px'
    snippet.onmousedown = dragCode
    area.appendChild(snippet)
}

function dragCode(e) 
{
  e.preventDefault()
  if (e.target.onclick)
  {
    e.target.click()
    return
  }
  area['clicklock'] = true;
  var snippet = e.currentTarget
  for (var x = 0; x < area.childElementCount; x++)
    area.children[x].removeAttribute('active')
  snippet.setAttribute('active', 'true')
  active = snippet
  const offsetY = snippet.offsetTop - e.clientY
  const offsetX = snippet.offsetLeft - e.clientX
  var move = function(e) 
             {
                e.preventDefault()
                var x = e.clientX + offsetX
                var y = e.clientY + offsetY
                if ((x > 0) && (x + snippet.offsetWidth < window.innerWidth))
                snippet.style.left = String(e.clientX + offsetX) + 'px'
                if ((y > 0) && (y + snippet.offsetHeight < window.innerHeight))
                  snippet.style.top = String(e.clientY + offsetY) + 'px'
             }
  var stopmove = function(e)
                 {
                    e.preventDefault()
                    document.onmousemove = null
                    document.onmouseup = null
                 }
  document.onmousemove = move
  document.onmouseup = stopmove
}
document.onkeydown = (e) => {
  if (active.caret == null) {
    active.lastChild.appendChild(document.createElement('nth-expression'))
    active.caret = active.lastChild.lastChild
    active.caret['symbol'] = null;
    active.caret.setAttribute('active', 'true')
  }
  if (e.ctrlKey) return
  if (e.key.length == 1) {
    e.preventDefault()
    switch(e.key) {
      case '(':
        insertExpression()
      break;
      case ')':
        outwards()
      break;
      case ' ':
        insertSymbol()
      break;
      default:
        insertCharacter(e.key)
    }
  }
  else {
    if (e.shiftKey) return
    e.preventDefault();
    switch(e.key) {
      case 'Enter': 
        insertBreak()
      break
      case 'Tab':
        growTab()
      break
      case 'Backspace': 
        backspace()
      break
      case 'Delete':
        removeExpression()
      break
      case 'ArrowRight':
        forwards()
      break
      case 'ArrowLeft':
        backwards()
      break
      case 'ArrowUp':
        outwards()
      break
      case 'ArrowDown':
        inwards()
      break
      case 'Escape':
        active.removeAttribute('active')
        active = null
      break
    }
  }
}
function insertCharacter(c) 
{
  var caret = active.caret;
  if (caret.symbol == null || caret.symbol.tagName == 'BR' || ( caret.symbol.textContent.length > 0 && !/\S/.test(caret.symbol.textContent)))
  {
    insertSymbol()
  }
  caret.symbol.textContent = caret.symbol.textContent + c
}
function insertSymbol() 
{
  var caret = active.caret;
  //if (caret.symbol && caret.symbol.tagName == 'NTH-SYMBOL' && caret.symbol.textContent == '') return
  var s = document.createElement('nth-symbol')
  s.appendChild(document.createTextNode(''))
  s.setAttribute('active', 'true')
  s.onclick = (e) => {
    active.caret.removeAttribute('active')
    if (active.caret.symbol != null)
      active.caret.symbol.removeAttribute('active')
    active.caret = e.target.parentElement
    active.caret.setAttribute('active', 'true')
    active.caret.symbol = e.target
    active.caret.symbol.setAttribute('active', 'true')
  }
  if (caret.symbol) caret.symbol.removeAttribute('active');
  if (caret.childElementCount == 0) 
  {
    caret.appendChild(s)
    caret.symbol = caret.firstChild
  }
  else if (caret.symbol.nextSibling)
  {
    caret.insertBefore(s, caret.symbol.nextSibling)
    caret.symbol = caret.symbol.nextSibling
  }
  else
  {
    caret.appendChild(s)
    caret.symbol = caret.lastChild
  } 
}
function insertExpression() 
{
  var caret = active.caret
  var e = document.createElement('nth-expression')
  e['symbol'] = null;
  e.setAttribute('active', 'true')
  caret.removeAttribute('active');
  if (caret.symbol != null) caret.symbol.removeAttribute('active')
  if (caret.childElementCount == 0)
  {
    caret.appendChild(e)
    active.caret = caret.firstChild;
  }
  else if (caret.symbol.nextSibling)
  {
    caret.insertBefore(e, caret.symbol.nextSibling)
    active.caret = caret.symbol.nextSibling
  }
  else
  {
    caret.appendChild(e)
    active.caret = caret.lastChild
  }
}
function insertBreak() 
{
  var caret = active.caret
  var b = document.createElement('br')
  if (caret.childElementCount == 0) return
  else
  {
    caret.symbol.removeAttribute('active')
    if (caret.symbol.nextSibling)
    {
      caret.insertBefore(b, caret.symbol.nextSibling)
    }
    else 
    {
      caret.appendChild(b)
    }
    active.caret.symbol = caret.symbol.nextSibling
  }
}
function growTab() 
{
  var caret = active.caret
  if (caret.symbol && caret.symbol.tagName == 'NTH-SYMBOL')
  {
    if (!/\S/.test(caret.symbol.textContent))
      caret.symbol.textContent = caret.symbol.textContent + '\u00a0'
  }
  else
  {
    insertSymbol()
  }
}
function backspace() 
{
  var caret = active.caret
  if (caret.childElementCount > 0)
  {
    if (caret.symbol.textContent.length > 0)
    {
      caret.symbol.textContent = caret.symbol.textContent.slice(0, -1)
    }
    else 
    {
      if (caret.symbol.previousSibling)
      {
        var temp = caret.symbol
        active.caret.symbol = caret.symbol.previousSibling
        active.caret.symbol.setAttribute('active', 'true')
        caret.removeChild(temp)
      }
      else
      {
        if (caret.childElementCount == 0)
        {
          caret.replaceChildren()
          active.caret.symbol = null
        }
      }
    }
  }
  else removeExpression()
}
function removeExpression() 
{
  var caret = active.caret
  var temp = caret
  if (caret.parentElement.tagName == 'NTH-EXPRESSION')
    active.caret = caret.parentElement
  else return
  if (temp.previousSibling) active.caret.symbol = temp.previousSibling
  else if (temp.nextSibling) active.caret.symbol = temp.nextSibling
  else active.caret.symbol = null
  temp.parentElement.removeChild(temp)
  active.caret.setAttribute('active', 'true')
}
function forwards()
{
  var caret = active.caret
  if (caret.childElementCount == 0) return
  if (caret.symbol && caret.symbol.nextSibling)
  {
    caret.symbol.removeAttribute('active')
    caret.symbol = caret.symbol.nextSibling
    caret.symbol.setAttribute('active', 'true')
  }
}
function backwards()
{
  var caret = active.caret
  if (caret.childElementCount == 0) return
  if (caret.symbol && caret.symbol.previousSibling)
  {
    caret.symbol.removeAttribute('active')
    active.caret.symbol = caret.symbol.previousSibling
    active.caret.symbol.setAttribute('active', 'true')
  }
}
function inwards() 
{
 var caret = active.caret
 if (caret.symbol && caret.symbol.tagName == 'NTH-EXPRESSION')
 {
  caret.removeAttribute('active')
  active.caret = caret.symbol
  active.caret.setAttribute('active', 'true')
  if (active.caret.symbol != null)
    active.caret.symbol.setAttribute('active', 'true')
 }
 
}
function outwards() 
{
  var caret = active.caret
  var temp = caret
  if (caret.parentElement && caret.parentElement.tagName == 'NTH-EXPRESSION')
  {
    caret.removeAttribute('active')
    if (caret.symbol != null) caret.symbol.removeAttribute('active')
    active.caret = caret.parentElement
    active.caret.setAttribute('active', 'true')
    active.caret.symbol = temp
    active.caret.symbol.setAttribute('active', 'true')
  }
}
</script>