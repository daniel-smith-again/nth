<!DOCTYPE html>
<head>
<meta charset='utf-8'>
<title>Nth HyperDoc</title>
<style>
	body{font-size:calc((1vh + 1vw) * 0.5);}
	[contenteditable]{outline:0px none transparent;}
	[tabindex]{outline:0px none transparent;}
	h-cursor{height:0px;width:5ch;border-bottom:medium solid black;display:block;position:fixed;}
	v-cursor{height:5ch;width:0px;border-left:medium solid black;display:block;position:fixed;}
	nth-view{display:block;margin:auto;font-family:monospace;padding-top:13ch;margin-bottom:28ch;width:fit-content;max-width:60%;white-space:normal;word-break:break-all;}
	nth-view *{margin-left:0.5ch;margin-right:0.5ch;margin-top:0;margin-bottom:auto;}
	nth-expression, nth-sequence, nth-collection, nth-type, nth-quote, nth-insert, nth-spread, nth-string
	{display:inline-block;vertical-align:top;width:auto;height:fit-content;margin:0;border-radius:1ch;border:medium solid lightgray;border-top-style:none;border-bottom-style:none;justify-content:left;min-height:2ch;min-width:2ch;}
	nth-symbol{display:inline;min-height:2ch;min-width:1ch;vertical-align:top;}
	nth-symbol br{display:block;}
	nth-symbol + nth-symbol{margin-left:1ch;}
	nth-collection::before{content:"{";}
	nth-collection::after{content:"}";}
	nth-sequence *::after{content:",";}
	nth-sequence:last-child::after{content:"";}
	nth-type::before{content:"[";}
	nth-type::after{content:"]";}
	nth-quote::before{content:"'";}
	nth-insert::before{content:"''";}
	nth-spread::before{content:"'''";}
	nth-string::before{content:'"';}
	nth-string::after{content:'"';}
</style>
</head>
<body>
<h1>The <i>n</i><sup>th</sup> Reference Implementation</h1>
<h-cursor><p id="info" style="position:relative;left:1ch;border-radius:1ch;">This is info about the editor state.</p></h-cursor>
<v-cursor><p id="state" style="position:relative;top:3ch;left:1ch;border-radius:1ch;background-color:white;width:fit-content;min-width:80ch;"><span id="EditorMode">&#x25cb;</span><br>This is info about the stuff your typing.<br>Here's more info...</p></v-cursor>
<nth-view><nth-expression><nth-symbol>Press</nth-symbol><nth-symbol>enter</nth-symbol><nth-symbol>to</nth-symbol><nth-symbol>edit</nth-symbol><nth-symbol>this</nth-symbol><nth-symbol>expression.</nth-symbol></nth-expression></nth-view>
</body>
<!--
	Editor operations
	Two modes, expression editor and structure editor.
	
	expression editor:
	alphanum	-	append to symbol
	space		-	new symbol
	backspace	-	delete last action
	hold backspace	-	delete symbol
	enter		-	line break
	tab		-	align symbol
	hold enter	-	exit mode
	esc		-	exit mode
	l/r arrow	-	move cursor
	open paren	-	new expression
	close paren	-	close expression stay in mode
	click		-	move cursor
	curly brackets	-	collection 
	square brackets	-	type
	apostrophe	-	quote
	comma		-	new expression in sequence


	structure editor:
	alphanum	-	nothing
	space		-	next symbol/expression
	hold space	-	next expression
	backspace	-	previous symbol/expression
	hold backspace	-	previous expression
	hold enter	-	edit expression
	enter		-	new expression
	curly braces	-	new collection
	square braces	-	new type
	apostrophe	-	new quote
	l/r arrow	-	relative visual cursor move
	u/d arrow	-	relative visual cursor move

	html elements
	"nth-view"		-	code view container
	"nth-expression"	-	expression
	"nth-exp-sequence"	-	sequence expression
	"nth-exp-collection"	-	collection constructor
	"nth-exp-type"		-	type constructor
	"nth-exp-quote"	-	quote constructor
	"nth-symbol"		-	symbol (including numbers)
-->
<script>
var editor = document.getElementsByTagName('nth-view')[0];
editor.tabIndex = true;
editor.focus();
var expression = editor.firstChild;
expression.cursor = 1;
editor.onkeyup = StructureEditorInput;
editor.onclick = MouseClick;
document.onclick = MouseClick;
var Mode = true;
editor.onkeydown = KeyHold;
var Ignore = null;
var hcursor = document.getElementsByTagName('h-cursor')[0];
var vcursor = document.getElementsByTagName('v-cursor')[0];
DisplayCursor();

function StructureEditorInput(key) {
	if (key.isComposing || key.keyCode === 229) {return;}
	if ((key.key == Ignore) && (!key.repeat)) {Ignore = null;}
	else if ((key.key == Ignore) && key.repeat) {key.preventDefault(); return;}
	else {
		if (Mode) switch (key.key) {
			case 'Enter':
				if (!key.repeat) {EditExpression();}
				else {InsertExpression();}
				break;
			case ' ':
				if (!key.repeat) {NextExpression();}
				else {InnerExpression();}
				break;
			case 'Backspace':
				if (!key.repeat) {PrevExpression();}
				else {DeleteNode();}
				break;
			case '(':
				if (!key.repeat) {InsertExpression();}
				break;
			case '{':
				if (!key.repeat) {InsertCollection();}
				break;
			case '[':
				if (!key.repeat) {InsertType();}
				break;
			case '\'':
				if (!key.repeat) {InsertQuote();}
				break;
			case '"':
				if (!key.repeat) {InsertString();}
			case 'ArrowLeft':
				PrevExpression();
				break;
			case 'ArrowRight':
				NextExpression();
				break;
			case 'ArrowUp':
				OuterExpression();
				break;
			case 'ArrowDown':
				InnerExpression();
				break;
			default: {return;}
		}
		else switch (key.key) {
			case ' ':
				if (!key.repeat) {InsertSymbol();}
				else {NextSymbol();}
				break;
			case 'Backspace':
				if (!key.repeat) {DeleteSymbol();}
				else{PrevSymbol();}
				break;
			case 'Enter':
				if (!key.repeat) {InsertLineBreak();}
				else {CloseExpression();}
				break;
			case 'Tab':
				if (!key.repeat) {AlignNode();}
				break;
			case 'Escape':
				CloseExpression();
				break;
			case 'ArrowLeft':
				PrevSymbol();
				break;
			case 'ArrowRight':
				NextSymbol();
				break;
			case '(':
				if (!key.repeat) {InsertExpression();}
				break;
			case '{':
				if (!key.repeat) {InsertCollection();}
				break;
			case '[':
				if (!key.repeat) {InsertType();}
				break;
			case '}':
			case ']':
			case ')':
				if (!key.repeat) {CloseExpression();}
				break;
			case '\'':
				if (!key.repeat) {InsertQuote();}
				break;
			case ',':
				if (!key.repeat) {AppendToSequence();}
				break;
			default: 
				if (key.key.length == 1) {AppendToSymbol(key.key);}
				break;
		}
	}
	if (key.repeat) Ignore = key.key;
	key.preventDefault();
}
function MouseClick (e) {
	e.preventDefault();
	editor.focus();
}
function KeyHold(key) {
	if (key.isComposing || key.keyCode === 229) {return;}
	if (key.repeat) {
		editor.onkeyup(key);
	}
}
function DisplayCursor () {
	console.log("Display Cursor");
	var pos = null;
	if (expression.cursor < expression.childNodes.length && expression.cursor > 0) {
		pos = expression.childNodes[expression.cursor - 1].getBoundingClientRect();
		vcursor.style.height = window.innerHeight - pos.y + 'px';
		vcursor.style.left = pos.x - 7 + 'px';
		vcursor.style.top = pos.y + 'px';
		hcursor.style.width = pos.x + pos.width + 'px';
		hcursor.style.top = pos.y + pos.height + 'px';
	}
	else if (expression.cursor == expression.childNodes.length && expression.cursor > 0) {
		pos = expression.lastChild.getBoundingClientRect();
		vcursor.style.height = window.innerHeight - pos.y + 'px';
		vcursor.style.left = pos.x - 7 + 'px';
		vcursor.style.top = pos.y + 'px';
		hcursor.style.width = pos.x + pos.width + 'px';
		hcursor.style.top = pos.y + pos.height + 'px';
	}
	else {
		pos = expression.getBoundingClientRect();
		vcursor.style.height = window.innerHeight - pos.y + 'px';
		vcursor.style.left = pos.x + 'px';
		vcursor.style.top = pos.y - 7 + 'px';
		hcursor.style.width = pos.x + pos.width + 'px';
		hcursor.style.top = pos.y + pos.height + 'px';
	}
	var bottom = editor.getBoundingClientRect();
	document.getElementById('state').style.top = bottom.bottom - pos.y + 27 + 'px';
	document.style.height += vcursor.style.height;
}
function CursorForward () {
	if (expression.cursor < expression.childNodes.length) {
		expression.cursor ++;
	}
	DisplayCursor();
}
function CursorBack () {
	if (expression.cursor > 0) {
		expression.cursor --;
	}
	DisplayCursor();
}
function AppendToSymbol (c) {
	if (! (expression.childNodes.length > 0)) {
		InsertSymbol();
	}
	if (expression.cursor == 0) {
		InsertSymbol();
	}
	var sym = expression.childNodes[expression.cursor - 1];
	if (sym.tagName.startsWith('NTH-SYMBOL')) {
		sym.textContent += c;
	}
	DisplayCursor();
}
function InsertExpression () {
	console.log("insert expression");
	if (expression) {
		var temp = document.createElement('nth-expression');
		temp.style.boxShadow = '0ch 0ch 3ch -0.5ch black';
		temp.cursor = 0;
		switch (expression.tagName) {
			case 'NTH-EXPRESSION' : {
				if (expression.childNodes.length == 0 || expression.cursor == expression.childNodes.length) {
					expression.appendChild(temp);
				}
				else if (expression.cursor == 0) {
					var next = expression.firstChild;
					expression.insertBefore(temp, next);
				}
				else {
					var next = expression.childNodes[expression.cursor];
					expression.insertBefore(temp, next);
				}
				CursorForward();
			} break;
			default: break;
		}
		expression.style.boxShadow = 'none';
		expression = temp;
	}
	else {
		expression = document.createElement('nth-expression');
		expression.style.boxShadow = '0ch 0ch 3ch -0.5ch black';
		expression.cursor = 0;
		editor.appendChild(expression);
		CursorBack();
	}
	Mode = false;
	document.getElementById('EditorMode').textContent = '\u25c9';
}
function AppendToSequence () {

}
function InsertCollection () {
}
function InsertType () {

}
function InsertQuote () {

}
function InsertSymbol () {
	if (expression.childNodes.length > 0) {
		if (expression.cursor == 0) {
			expression.insertBefore(document.createElement('nth-symbol'), expression.firstChild);
		}
		else if (expression.cursor == expression.childNodes.length) {
			if (expression.lastChild.tagName == 'NTH-SYMBOL' && expression.lastChild.textContent.length == 0) {
				return;
			} else {
				expression.appendChild(document.createElement('nth-symbol'));
			}
		}
		else {
			expression.insertBefore(document.createElement('nth-symbol'), expression.childNodes[expression.cursor])
		}
	}
	else {
		expression.appendChild(document.createElement('nth-symbol'));
	}
	CursorForward();
}
function InsertLineBreak () {
	if (expression.childNodes.length > 0) {
		if (expression.cursor > 0) {
			if (expression.childNodes[expression.cursor - 1].tagName != 'BR') {
				if (expression.cursor == expression.childNodes.length) {
					expression.appendChild(document.createElement('br'));
				}
				else {
					expression.insertBefore(document.createElement('br'), expression.childNodes[expression.cursor - 1]);
				}
				CursorForward();
			}
		}
	}
}
function AlignNode () {

}
function DeleteSymbol () {
	if (expression.childNodes.length > 0) {
		if (expression.cursor > 0) {
			var sym = expression.childNodes[expression.cursor - 1];
			if (sym.tagName == 'NTH-SYMBOL') {
				if (sym.textContent.length > 0) {
					sym.textContent = '';
					DisplayCursor();
				}
				else {
					sym.remove();
					CursorBack();
				}
			}
			else if (sym.tagName == 'BR') {
				sym.remove();
				CursorBack();
			}
		}
	}

}
function DeleteNode () {
	if (expression.parentNode.tagName != 'NTH-VIEW') {
		var temp = expression;
		expression = expression.parentNode;
		temp.remove();
		CursorBack();
		expression.style.boxShadow = '0ch 0ch 3ch -0.5ch black';
	}

}
function NextSymbol () {
	CursorForward();
}
function PrevSymbol () {
	CursorBack();
}
function PrevExpression () {
	var p = null;
	if (expression.previousSibling) {
		p = expression.previousSibling;
		while (!(p.tagName.startsWith('NTH-EXP'))) {
			if (p.previousSibling) {
				p = p.previousSibling;
			}
			else {
				break;
			}
		}
		if (p.tagName.startsWith('NTH-EXP')) {
			expression.style.boxShadow = 'none';
			expression = p;
			expression.style.boxShadow = '0ch 0ch 3ch -0.5ch black';
		}
	}
	DisplayCursor();
}
function NextExpression () {
	var p = null;
	if (expression.nextSibling) {
		p = expression.nextSibling;
		while (!(p.tagName.startsWith('NTH-EXP'))) {
			if (p.nextSibling) {
				p = p.nextSibling;
			}
			else {
				break;
			}
		}
		if (p.tagName.startsWith('NTH-EXP')) {
			expression.style.boxShadow = 'none';
			expression = p;
			expression.style.boxShadow = '0ch 0ch 3ch -0.5ch black';
		}
	}
	DisplayCursor()
}
function OuterExpression () {
	if (expression.parentNode.tagName != 'NTH-VIEW') {
		var n = 0;
		for (x in expression.parentNode.childNodes) {
			if (expression.parentNode.childNodes[x] == expression) {
				console.log(x);
				n = x;
				break;
			}
		}
		expression.style.boxShadow = 'none';
		expression = expression.parentNode;
		expression.style.boxShadow = '0ch 0ch 3ch -0.5ch black';
		expression.cursor = Number(n) + 1;
	}
	DisplayCursor();
}
function InnerExpression () {
	if (expression.childNodes.length > 0) {
		var temp = null;
		if (expression.cursor > 0) 
			temp = expression.childNodes[expression.cursor - 1];
		else
			temp = expression.firstChild;
		var cursorinc = 0;
		while (!temp.tagName.startsWith('NTH-EXP')) {
			if (temp.nextSibling) {
				temp = temp.nextSibling;
				cursorinc ++;
			}
			else {
				break;
			}
		}
		if (temp.tagName.startsWith('NTH-EXP')) {
			expression.cursor += cursorinc;
			expression.style.boxShadow = 'none';
			expression = temp;
			expression.style.boxShadow = '0ch 0ch 3ch -0.5ch black';
		}
	}
	DisplayCursor();
}
function CloseExpression () {
	Mode = true;
	document.getElementById('EditorMode').textContent = '\u25cb';
	if (expression.parentElement.tagName != 'NTH-VIEW') {
		expression.style.boxShadow = 'none';
		expression = expression.parentElement;
		expression.style.boxShadow = '0ch 0ch 3ch -0.5ch black';
	}
	DisplayCursor();
}
function EditExpression () {
	expression.style.boxShadow ='0ch 0ch 3ch -0.5ch black';
	Mode = false;
	document.getElementById('EditorMode').textContent = '\u25c9';
	DisplayCursor();
}
</script>