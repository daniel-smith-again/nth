<!DOCTYPE html>
<head>
<meta charset='utf-8'>
<title>Nth HyperDoc</title>
<style>
	body{font-size:calc((1vw + 1vh) * 0.7);font-family:serif;}
	[contenteditable]{outline:0px none transparent;}
	[tabindex]{outline:0px none transparent;}
	h-cursor{height:0px;width:5ch;border-bottom:medium solid black;display:block;position:fixed;transition:all 0.2s;}
	v-cursor{height:5ch;width:0px;border-left:medium solid black;display:block;position:fixed;transition:all 0.2s;}
	nth-view{display:block;margin:auto;font-family:monospace;margin-top:13ch;margin-bottom:32ch;width:fit-content;max-width:60%;white-space:normal;word-break:break-all;caret-color:transparent;transition:all 0.2s;}
	nth-view *{margin-left:0.5ch;margin-right:0.5ch;margin-top:0;margin-bottom:auto;}
	nth-expression, nth-symbol, nth-string{font-family:monospace;}
	nth-expression
	{display:inline-block;vertical-align:top;width:auto;height:fit-content;margin:0;border-radius:0.5ch;border:thin solid lightgray;border-top-style:none;border-bottom-style:none;justify-content:left;min-height:2ch;min-width:2ch;}
	nth-symbol, nth-comma{display:inline;min-height:2ch;min-width:1ch;vertical-align:top;}
	nth-symbol + nth-symbol{margin-left:1ch;}
	nth-symbol + nth-comma, nth-expression + nth-comma{margin-left:-0.5ch;}
	nth-string{border-style:none;}
	nth-string::before{content:'"';}
	nth-string::after{content:'"';}
	h-cursor p{position:relative;left:1ch;top:-4ch;border-radius:1ch;display:block;}
	#Result {left:1ch;top:-4ch;} #Result *{font-family:monospace;}
</style>
</head>
<body>
<p id='Header' style="transition:all 0.2s;width:25%;border-bottom:medium solid black;position:fixed;top:120vh;opacity:0;right:0;">The <i>n</i><sup>th</sup> Reference Implementation</p>
<h-cursor>
	<p id="Result">Result:<span></span></p>
	<p id="info">This is info about the runtime state.<br><br><nth-expression>Fake-code</nth-expression><br><nth-expression>more fake-code</nth-expression><br><nth-string>a fake constant</nth-string></p>
</h-cursor>
<v-cursor><p id="state" style="position:relative;top:3ch;left:1ch;border-radius:1ch;background-color:white;width:fit-content;min-width:80ch;"><span id="EditorMode">&#x25ce;</span><br>This is info about the stuff your typing.<br>Here's more info...</p></v-cursor>
<nth-view contenteditable="true" autofocus="true" spellcheck="false"><nth-expression><nth-symbol>Press</nth-symbol><nth-symbol>enter</nth-symbol><nth-symbol>to</nth-symbol><nth-symbol>edit</nth-symbol><nth-symbol>this</nth-symbol><nth-symbol>expression.</nth-symbol></nth-expression></nth-view>
</body>
<!--
	Editor operations
	Two modes, expression editor and structure editor.
	
	expression editor:
	alphanum	-	append to symbol
	space		-	new symbol
	backspace	-	delete last action
	hold backspace	-	delete symbol
	enter		-	line break
	tab		-	align symbol
	hold enter	-	exit mode
	esc		-	exit mode
	l/r arrow	-	move cursor
	open paren	-	new expression
	close paren	-	close expression stay in mode
	click		-	move cursor
	curly brackets	-	collection 
	square brackets	-	type
	apostrophe	-	quote
	comma		-	new expression in sequence


	structure editor:
	alphanum	-	nothing
	space		-	next symbol/expression
	hold space	-	next expression
	backspace	-	previous symbol/expression
	hold backspace	-	previous expression
	hold enter	-	edit expression
	enter		-	new expression
	curly braces	-	new collection
	square braces	-	new type
	apostrophe	-	new quote
	l/r arrow	-	relative visual cursor move
	u/d arrow	-	relative visual cursor move

	html elements
	"nth-view"		-	code view container
	"nth-expression"	-	expression
	"nth-exp-sequence"	-	sequence expression
	"nth-exp-collection"	-	collection constructor
	"nth-exp-type"		-	type constructor
	"nth-exp-quote"	-	quote constructor
	"nth-symbol"		-	symbol (including numbers)
	"nth-string"		-	string data
-->
<script>
var editor = document.getElementsByTagName('nth-view')[0];
editor.autocapitalize = 'off';
editor.focus();
var expression = editor.firstChild;
expression.cursor = 1;
editor.onkeyup = StructureEditorInput;
editor.onclick = MouseClick;
editor.onpaste = (e) => {e.preventDefault();}
document.onclick = MouseClick;
var Mode = true;
var CharacterEscape = false;
var StringInput = false;
editor.onkeydown = KeyHold;
var Ignore = null;
var hcursor = document.getElementsByTagName('h-cursor')[0];
var vcursor = document.getElementsByTagName('v-cursor')[0];
DisplayCursor();
document.getElementById('Header').style.cssText += 'top:0px;opacity:1;';

function StructureEditorInput(key) {
	if (key.isComposing || key.keyCode === 229) {return;}
	key.preventDefault();
	if ((key.key == Ignore) && (!key.repeat)) {Ignore = null;}
	else if ((key.key == Ignore) && key.repeat) {key.preventDefault(); return;}
	else if (CharacterEscape) {
		if (key.key.length == 1) {
			AppendToSymbol(key.key);
			CharacterEscape = false;
		}
	}
	else if (StringInput) {
		
		switch(key.key) {
			case 'ArrowLeft':
				PrevSymbol();
				break;
			case 'ArrowRight':
				NextSymbol();
				break;
			case 'Backspace':
				if (!key.repeat) {DeleteSymbol();}
				break;
			case '"':
				StringInput = false;
				CursorForward();
				break;
			default:
				if (key.key.length == 1)
					AppendToSymbol(key.key);
				break;
		}
	}
	else {
		if (Mode) switch (key.key) {
			case 'Enter':
				if (!key.repeat) {EditExpression();}
				else {InsertExpression();}
				break;
			case ' ':
				if (!key.repeat) {NextExpression();}
				else {InnerExpression();}
				break;
			case 'Escape':
				OuterExpression();
				break;
			case 'Backspace':
				if (!key.repeat) {PrevExpression();}
				else {DeleteNode();}
				break;
			case '(':
				if (!key.repeat) {InsertExpression();}
				break;
			case '{':
			case '[':
			case '\'':
				break;
			case 'ArrowLeft':
				PrevExpression();
				break;
			case 'ArrowRight':
				NextExpression();
				break;
			case 'ArrowUp':
				OuterExpression();
				break;
			case 'ArrowDown':
				InnerExpression();
				break;
			default: {return;}
		}
		else switch (key.key) {
			case ' ':
				if (expression.cursor > 0 && expression.cursor < expression.childNodes.length && expression.childNodes[expression.cursor - 1].tagName == 'NTH-STRING') {
					StringInput = true;
					AppendToSymbol(key.key);
				}
				else {
					if (!key.repeat) {InsertSymbol();}
					else {NextSymbol();}
				}
				break;
			case 'Backspace':
				if (!key.repeat) {DeleteSymbol();}
				else{PrevSymbol();}
				break;
			case 'Enter':
				if (!key.repeat) {InsertLineBreak();}
				else {CloseExpression();}
				break;
			case 'Tab':
				if (!key.repeat) {AlignNode();}
				break;
			case 'Escape':
				CloseExpression();
				break;
			case 'ArrowLeft':
				PrevSymbol();
				break;
			case 'ArrowRight':
				NextSymbol();
				break;
			case '(':
				if (!key.repeat) {InsertExpression();}
				break;
			case '{':
			case '[':
			case '}':
			case ']':
				break;
			case ')':
				if (!key.repeat) {CloseExpression();}
				break;
			case '\'':
				break;
			case ',':
				if (!key.repeat) {InsertSequence();}
				break;
			case '"':
				if (!key.repeat) {InsertString(); StringInput = true;}
				break;
			case '\\':
				if (!key.repeat) {AppendToSymbol(key.key); CharacterEscape = true;}
			default: 
				if (key.key.length == 1) {
					if (expression.cursor > 0 && expression.cursor < expression.childNodes.length && expression.childNodes[expression.cursor - 1].tagName == 'NTH-STRING')
						StringInput = true;
					AppendToSymbol(key.key);
				}
				break;
		}
	}
	if (key.repeat && Mode) switch(key.key) {
		case 'ArrowLeft':
		case 'ArrowRight':
		case 'ArrowUp':
		case 'ArrowDown':
			break;
		default:
			Ignore = key.key;
			break;
	}
	else if (key.repeat && !Mode) switch(key.key) {
		case 'ArrowLeft':
		case 'ArrowRight':
		case 'ArrowUp':
		case 'ArrowDown':
		case 'Backspace':
		case ' ':
			break;
		default:
			Ignore = key.key;
			break;
	}
	
}
function MouseClick (e) {
	e.preventDefault();
	editor.focus();
}
function KeyHold(key) {
	key.preventDefault();
	if (key.isComposing || key.keyCode === 229) {return;}
	if (key.repeat && key.key != 'Shift' && key.key != 'Control') {
		editor.onkeyup(key);
	}
}
function DisplayCursor () {
	var pos = null;
	if (expression.cursor < expression.childNodes.length && expression.cursor > 0) {
		pos = expression.childNodes[expression.cursor - 1].getBoundingClientRect();
		vcursor.style.height = window.innerHeight - pos.y + 'px';
		vcursor.style.left = pos.x - 3 + 'px';
		vcursor.style.top = pos.y + 'px';
		hcursor.style.width = pos.x + pos.width + 'px';
		hcursor.style.top = pos.y + pos.height + 'px';
	}
	else if (expression.cursor == expression.childNodes.length && expression.cursor > 0) {
		pos = expression.lastChild.getBoundingClientRect();
		vcursor.style.height = window.innerHeight - pos.y + 'px';
		vcursor.style.left = pos.x - 3 + 'px';
		vcursor.style.top = pos.y + 'px';
		hcursor.style.width = pos.x + pos.width + 'px';
		hcursor.style.top = pos.y + pos.height + 'px';
	}
	else {
		pos = expression.getBoundingClientRect();
		vcursor.style.height = window.innerHeight - pos.y + 'px';
		vcursor.style.left = pos.x + 'px';
		vcursor.style.top = pos.y - 3 + 'px';
		hcursor.style.width = pos.x + pos.width + 'px';
		hcursor.style.top = pos.y + pos.height + 'px';
	}
	var bottom = editor.getBoundingClientRect();
	document.getElementById('state').style.top = (bottom.bottom - pos.y) + 'px';
}
function CursorForward () {
	if (expression.cursor < expression.childNodes.length) {
		expression.cursor ++;
	}
	DisplayCursor();
}
function CursorBack () {
	if (expression.cursor > 0) {
		expression.cursor --;
	}
	DisplayCursor();
}
function AppendToSymbol (c) {
	if (! (expression.childNodes.length > 0)) {
		InsertSymbol();
	}
	if (expression.cursor == 0) {
		InsertSymbol();
	}
	var sym = expression.childNodes[expression.cursor - 1];
	if (sym.tagName.startsWith('NTH-S')) {
		if (c == ' ')
			sym.textContent += '\xa0';
		else
			sym.textContent += c;
	}
	DisplayCursor();
}
function InsertExpression () {
	if (expression) {
		var temp = document.createElement('nth-expression');
		temp.style.boxShadow = '0ch 0ch 3ch -0.5ch black';
		temp.cursor = 0;
		switch (expression.tagName) {
			case 'NTH-EXPRESSION' : {
				if (expression.childNodes.length == 0 || expression.cursor == expression.childNodes.length) {
					expression.appendChild(temp);
				}
				else if (expression.cursor == 0) {
					var next = expression.firstChild;
					expression.insertBefore(temp, next);
				}
				else {
					var next = expression.childNodes[expression.cursor];
					expression.insertBefore(temp, next);
				}
				CursorForward();
			} break;
			default: break;
		}
		expression.style.boxShadow = 'none';
		expression = temp;
	}
	else {
		expression = document.createElement('nth-expression');
		expression.style.boxShadow = '0ch 0ch 3ch -0.5ch black';
		expression.cursor = 0;
		editor.appendChild(expression);
		CursorBack();
	}
	Mode = false;
	document.getElementById('EditorMode').textContent = '\u25c9';
}
function AppendToSequence () {
	if (expression.parentElement && expression.parentElement.tagName != 'NTH-VIEW') {
		
	}

}
function InsertCollection () {
}
function InsertType () {

}
function InsertQuote () {
	AppendToSymbol("'");
}
function InsertString () {
	if (expression.childNodes.length > 0) {
		if (expression.cursor == 0) {
			expression.insertBefore(document.createElement('nth-string'), expression.firstChild);
		}
		else if (expression.cursor == expression.childNodes.length) {
			if (expression.lastChild.tagName.startsWith('NTH-S') && expression.lastChild.textContent.length == 0) {
				return;
			} else {
				expression.appendChild(document.createElement('nth-string'));
			}
		}
		else {
			expression.insertBefore(document.createElement('nth-string'), expression.childNodes[expression.cursor])
		}
	}
	else {
		expression.appendChild(document.createElement('nth-string'));
	}
	CursorForward();
}
function InsertSymbol () {
	if (expression.childNodes.length > 0) {
		if (expression.cursor == 0) {
			expression.insertBefore(document.createElement('nth-symbol'), expression.firstChild);
		}
		else if (expression.cursor == expression.childNodes.length) {
			if (expression.lastChild.tagName.startsWith('NTH-S') && expression.lastChild.textContent.length == 0) {
				return;
			} else {
				expression.appendChild(document.createElement('nth-symbol'));
			}
		}
		else {
			expression.insertBefore(document.createElement('nth-symbol'), expression.childNodes[expression.cursor])
		}
	}
	else {
		expression.appendChild(document.createElement('nth-symbol'));
	}
	CursorForward();
}
function InsertLineBreak () {
	if (expression.childNodes.length > 0) {
		if (expression.cursor > 0) {
			if (expression.childNodes[expression.cursor - 1].tagName != 'BR') {
				if (expression.cursor == expression.childNodes.length) {
					expression.appendChild(document.createElement('br'));
				}
				else {
					expression.insertBefore(document.createElement('br'), expression.childNodes[expression.cursor - 1]);
				}
				CursorForward();
			}
		}
	}
}
function InsertSequence() {
	if (expression.childNodes.length > 0) {
		if (expression.cursor > 0) {
			if (expression.childNodes[expression.cursor - 1].tagName != 'NTH-COMMA') {
				if (expression.cursor == expression.childNodes.length) {
					expression.appendChild(document.createElement('nth-comma'));
					expression.lastChild.appendChild(document.createTextNode(','));
					CursorForward();
				}
				else {
					if (expression.childNodes[expression.cursor].tagName != 'NTH-COMMA') {
						var temp = document.createElement('nth-comma');
						temp.appendChild(document.createTextNode(','));
						expression.insertBefore(temp, expression.childNodes[expression.cursor]);
						CursorForward();
					}
				}
			}
		}
	}
}
function AlignNode () {

}
function DeleteSymbol () {
	if (expression.childNodes.length > 0) {
		if (expression.cursor > 0) {
			var sym = expression.childNodes[expression.cursor - 1];
			if (sym.tagName.startsWith('NTH-S')) {
				if (sym.textContent.length > 0) {
					sym.textContent = '';
					DisplayCursor();
				}
				else {
					sym.remove();
					CursorBack();
				}
			}
			else if (sym.tagName == 'BR') {
				sym.remove();
				CursorBack();
			}
			else if (sym.tagName == 'NTH-COMMA') {
				sym.remove();
				CursorBack();
			}
		}
	}

}
function DeleteNode () {
	if (expression.parentNode.tagName != 'NTH-VIEW') {
		var temp = expression;
		expression = expression.parentNode;
		temp.remove();
		CursorBack();
		expression.style.boxShadow = '0ch 0ch 3ch -0.5ch black';
	}

}
function NextSymbol () {
	StringInput = false;
	CursorForward();
}
function PrevSymbol () {
	StringInput = false;
	CursorBack();
}
function PrevExpression () {
	var p = null;
	if (expression.previousSibling) {
		p = expression.previousSibling;
		while (!(p.tagName.startsWith('NTH-EXP'))) {
			if (p.previousSibling) {
				p = p.previousSibling;
			}
			else {
				break;
			}
		}
		if (p.tagName.startsWith('NTH-EXP')) {
			expression.style.boxShadow = 'none';
			expression = p;
			expression.style.boxShadow = '0ch 0ch 3ch -0.5ch black';
		}
	}
	DisplayCursor();
}
function NextExpression () {
	var p = null;
	if (expression.nextSibling) {
		p = expression.nextSibling;
		while (!(p.tagName.startsWith('NTH-EXP'))) {
			if (p.nextSibling) {
				p = p.nextSibling;
			}
			else {
				break;
			}
		}
		if (p.tagName.startsWith('NTH-EXP')) {
			expression.style.boxShadow = 'none';
			expression = p;
			expression.style.boxShadow = '0ch 0ch 3ch -0.5ch black';
		}
	}
	DisplayCursor()
}
function OuterExpression () {
	if (expression.parentNode.tagName != 'NTH-VIEW') {
		var n = 0;
		for (x in expression.parentNode.childNodes) {
			if (expression.parentNode.childNodes[x] == expression) {
				n = x;
				break;
			}
		}
		expression.style.boxShadow = 'none';
		expression = expression.parentNode;
		expression.style.boxShadow = '0ch 0ch 3ch -0.5ch black';
		expression.cursor = Number(n) + 1;
	}
	else {
		expression.cursor = 0;
		expression.style.boxShadow = 'none';
	}
	DisplayCursor();
}
function InnerExpression () {
	if (expression.childNodes.length > 0) {
		var temp = null;
		if (expression.cursor > 0) 
			temp = expression.childNodes[expression.cursor - 1];
		else
			temp = expression.firstChild;
		var cursorinc = 0;
		while (!temp.tagName.startsWith('NTH-EXP')) {
			if (temp.nextSibling) {
				temp = temp.nextSibling;
				cursorinc ++;
			}
			else {
				break;
			}
		}
		if (temp.tagName.startsWith('NTH-EXP')) {
			expression.cursor += cursorinc;
			expression.style.boxShadow = 'none';
			expression = temp;
			expression.style.boxShadow = '0ch 0ch 3ch -0.5ch black';
		}
		else {
			while(!temp.tagName.startsWith('NTH-EXP')) {
				if (temp.previousSibling) {
					temp = temp.previousSibling;
					cursorinc --;
				}
				else {
					break;
				}
			}
			if (temp.tagName.startsWith('NTH-EXP')) {
				expression.cursor += cursorinc;
				expression.style.boxShadow = 'none';
				expression = temp;
				expression.style.boxShadow = '0ch 0ch 3ch -0.5ch black';
			}
		}
	}
	DisplayCursor();
}
function CloseExpression () {
	Mode = true;
	document.getElementById('EditorMode').textContent = '\u25ce';
	if (expression.parentElement.tagName != 'NTH-VIEW') {
		expression.style.boxShadow = 'none';
		expression = expression.parentElement;
		expression.style.boxShadow = '0ch 0ch 3ch -0.5ch black';
	}
	DisplayCursor();
	Evaluate();
}
function EditExpression () {
	expression.style.boxShadow ='0ch 0ch 3ch -0.5ch black';
	Mode = false;
	document.getElementById('EditorMode').textContent = '\u25c9';
	DisplayCursor();
}
function Evaluate () {
	document.getElementById('Result').lastChild.textContent = Math.random().toString();
}
</script>